# Contributing to <%= name %>

The following is a set of guidelines for contributing to the <%= name %> project.

## About

### Project structure

The project is structured as follows:

- `<%= srcDir %>/`: holds all the server/API source files
  - `index.js`: entry point of the application that holds all the Express server configuration (middlewares, routes, error handling...)
  - `config/`: application configuration files
  - `controllers/`: API routes controllers (request handlers)
  - `doc/`: API documentation
  - `routes/`: API routes definitions
  - `services/`: business logic files
  - `utils/`: utility functions and helpers used throughout the server files

<%_ if (winston) { _%>When running the app or performing some commands, additional folders (ignored by Git) will be created such as:

- `logs/`: application logs (errors, info, etc...) generated by `winston` when the application is running
  <%_ } _%>

### Routing

#### How to

- All routes should be defined in the `routes/` folder.
- New route files should be added to the `routes/index.js` file.
- Each file should represent a main route endpoint and its filename should match this endpoint: for example, `routes/articles.js` should define all routes from the `/articles` endpoint.
- Request handlers associated to these routes should be defined in the `controllers/` folder.
- The folder should mirror the `routes/` folder: one controller file per route file with a filename matching the associated route endpoint (ex: `controllers/articles.js`).
- Each controller should define and export one request handler function per route.
- Finally, all the business logic (retrieving, creating or updating data, etc) should be defined in the `services/` folder.

#### Example

To define a new endpoint `/articles` and two routes `GET /articles` and `GET /articles/:id`, follow the steps below.

- Create the service with the business logic to retrieve the articles:

  - Create a new file called `article.js` in the `services/` folder
  - In this new file, define and export two methods `getAllArticles` and `getArticleById`:

    ```javascript
    module.exports = {
      getAllArticles: async () => {
        // Fetch all articles from a database (using Sequelize for example)
        const articles = await Article.findAll();

        return articles;
      },

      getArticleById: async id => {
        // Fetch one article from a database (using Sequelize for example)
        const article = await Article.findByPk(id);

        return article;
      },
    };
    ```

- Create the route request handler:

  - Create a new file called `articles.js` in the `controllers/` folder
  - In this new file, define and export the request handlers associated to these routes:

    ```javascript
    const ArticleService = require('../services/article');

    module.exports = {
      getArticles: async (req, res, next) => {
        const articles = await ArticleService.getAllArticles();

        return articles;
      },

      getArticle: async (req, res, next) => {
        const { id } = req.params;
        const article = await ArticleService.getArticleById(id);

        return article;
      },
    };
    ```

- Create the endpoint and routes:

  - Create a new file called `articles.js` in the `routes/` folder
  - In this new file, initialize a router object, import the controller and the new routes with its associated request handlers:

    ```javascript
    const Router = require('express-promise-router').default;

    const articlesController = require('../controllers/articles');

    const router = Router();

    router.get('/', articlesController.getArticles);
    router.get('/:id', articlesController.getArticle);

    module.exports = router;
    ```

  - Finally, import the endpoint router in the `routes/index.js` file and declare the `/articles` route:

    ```javascript
    const articlesRouter = require('./articles');

    //
    // ─── API ROUTES ──────────────────────────────────────────────────────
    //
    router.use('/api/articles', articlesRouter);
    ```

<%_ if (celebrate) { _%>

### Object validation

Object validation (request parameters, request body, etc) should be handled by [celebrate](https://www.npmjs.com/package/celebrate).

To do this, add validation schemas in the route definitions by using the `celebrate` middleware.

For example, to add validation to the `id` parameter of the `GET /articles/:id` route, add the celebrate middleware in `routes/articles.js`:

```javascript
const Router = require('express-promise-router').default;
const { celebrate, Joi } = require('celebrate');

const articlesController = require('../controllers/articles');

const router = Router();

router.get(
  '/:id',
  celebrate({
    params: {
      id: Joi.number()
        .integer()
        .positive()
        .required(),
    },
  }),
  articlesController.getArticle
);
```

Validation errors are handled by the `celebrateErrorParser` middleware from [@kazaar/express-error-handler](https://www.npmjs.com/package/@kazaar/express-error-handler).

```javascript
//
// ─── GLOBAL ERROR HANDLING ──────────────────────────────────────────────────────
//
app.use(celebrateErrorParser);
```

<%_ } _%>

### Error handling

HTTP error responses are handled by the `httpErrorHandler` middleware from [@kazaar/express-error-handler](https://www.npmjs.com/package/@kazaar/express-error-handler).

```javascript
//
// ─── GLOBAL ERROR HANDLING ──────────────────────────────────────────────────────
//
app.use(httpErrorHandler);
```

When an error is thrown inside of a controller with `next()` or `throw`, this middleware will eventually parse the error as an HTTP error to retrieve the error details, log the error and send back the error to the client.

To throw custom HTTP errors, use the `http-errors` module:

```javascript
const { BadRequest } = require('http-errors');

// ...

if (!filename) {
  throw new BadRequest('Invalid or missing filename.');
}
```

In addition, the routes defined in `<%= srcDir %>/routes/` should use the `Router` from the `express-promise-router` package instead of the `express` package. It provides a convenient way to write async controller methods without `try/catch` blocks and `next()` (see [express-promise-router](https://github.com/express-promise-router/express-promise-router)).

<%_ if (winston) { _%>### Logs

When running, the application outputs some logs to the `logs/` folder. Two modules are used for this:

- [winston](https://github.com/winstonjs/winston): handles all application logs and writes the output to configured transports (file, console, etc)
- [morgan](https://github.com/expressjs/morgan): logs all incoming HTTP requests

In development mode (`NODE_ENV` set to `development`), the application will also output logs to the console.

Please refer to `<%= srcDir %>/config/winston.js` to see winston configuration.<%_ } _%>

<%_ if (openapi) { _%>### API documentation

The API documentation is written as an [OpenAPI](https://swagger.io/specification/) definition and located in the `<%= srcDir %>/doc/` folder.

The `openapi.yaml` acts as the entry point of the API definition.

The interface is generated by [ReDoc](https://github.com/Rebilly/ReDoc) and is available at `localhost:8080` when the server is running.
<%_ } _%>

### Version update

When updating the project's version number, do not forget to update:

- The `version` field in `package.json`
- The `info > version` field in `<%= srcDir %>/doc/openapi.yaml`

## Style Guide

### ES6

All the JavaScript source files located in `<%= srcDir %>/` are written in ES6 syntax (see [ECMAScript 6](https://www.w3schools.com/js/js_es6.asp)).

Most of the ES6 features are supported by the latest versions of Node (`async/await`, `let`, `const`...). However, some features like ES6's `import/export` require to be "transpiled" first for Node.js to understand them.

If you want to use ES6's `import/export` syntax instead of the CommonJS `require/module.exports` syntax, use [Babel](https://babeljs.io/).

### Filenames

All filenames should use `kebab-case` (ex: `well-known.js`).

### Formatting

Formatting rules are defined in `.editorconfig`<%_ if (prettier) { _%> and `.prettierrc`<%_ } _%>.

General formatting rules are:

- Indentation of **2 spaces**
- Max line length of **120 characters**
- **Single quotes** instead of double quotes

The rules defined in `.editorconfig` ensure that the coding style guide will stay consistent between different editors (see [EditorConfig](https://editorconfig.org/) for more info).
<%_ if (prettier) { _%>

The rules defined in `.prettierrc` provide more advanced formatting options (see [Linting](#Linting) section below).

<%_ } _%>

### Linting

#### ESLint<%_ if (prettier) { _%> & Prettier<%_ } _%>

This project uses:

- [ESLint](https://eslint.org/) for JavaScript errors linting and best practices
  <%_ if (prettier) { _%>
- [Prettier](https://prettier.io/docs/en/index.html) for code formatting
  <%_ } _%>

Two npm commands are available:

- `npm run lint`
- `npm run lint:fix`

<%_ if (!prettier) { _%>
The first one will check for linting errors and the second one will try to automatically fix these errors. Under the hood, these two commands run ESlint on `*.js` files. All files and folders defined in `.gitignore` will be ignored.
<%_ } _%>
<%_ if (prettier) { _%>
The first one will check for linting and formatting errors and the second one will try to automatically fix these errors. Under the hood, these two commands run ESlint on `*.js` files and Prettier on `*.{json,md,html,yaml}` files. All files and folders defined in `.gitignore` will be ignored.
<%_ } _%>

Configuration for these tools are defined in `.eslintrc`<%_ if (prettier) { _%> and `.prettierrc`<%_ } _%>. This project essentially uses Airbnb's [JavaScript Style Guide](https://github.com/airbnb/javascript) along with some eslint plugins to ensure coding best practices.

#### Pre-commit hook

In addition to these commands, a git pre-commit hook runs before each commit to ensure that linting and formatting are ok. All staged files run through the same linting process as the `lint:fix` npm command.

The hook was created with `husky` and configured to run `lint-staged`. It is defined in `package.json`.

More info:

- [Git hooks](https://git-scm.com/book/uz/v2/Customizing-Git-Git-Hooks)
- [husky](https://github.com/typicode/husky)
- [lint-staged](https://github.com/okonet/lint-staged)

### JSDoc

JavaScript functions should be annotated with [JSDoc](https://devhints.io/jsdoc). This allows to:

- Check the type of JavaScript code during code time
- Facilitate code readability
- Produce code documentation
